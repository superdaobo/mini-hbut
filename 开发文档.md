# Tauri App 开发文档

本文档用于说明 tauri-app 的本地开发、调试、构建与常见问题排查流程。

## 目录结构

- src/：前端（Vue 3）源码
- src-tauri/：Tauri Rust 后端
- public/：静态资源
- package.json：前端依赖与脚本
- src-tauri/Cargo.toml：Rust 依赖
- src-tauri/tauri.conf.json：Tauri 配置

## 环境准备

### 1) Node.js

- 推荐使用 Node.js 18+（与 Vite 生态兼容）

### 2) Rust

- 安装 Rust（含 cargo）

### 3) Tauri 依赖

Windows 下建议准备：
- Visual Studio Build Tools（含 C++ 生成工具）

## 安装依赖

在 tauri-app 目录执行：

- 前端依赖：
  - npm install

- Rust 依赖自动由 cargo 处理（首次构建会下载）

## 本地开发启动

### 前端（可独立调试）

- npm run dev

### 桌面应用（Tauri）

- npm run tauri dev

这会启动 Vite 开发服务器并打开桌面端窗口。

## 构建发布

### 前端构建

- npm run build

### Tauri 构建

- npm run tauri build

构建产物通常在：
- src-tauri/target/release/bundle

## 环境变量与配置

- 前端 API Base：
  - 使用 .env 或系统环境变量 VITE_API_BASE
  - 默认值为 /api

- Tauri 配置：
  - src-tauri/tauri.conf.json
  - 包含窗口、更新、打包等设置

## 常见调试入口

### 后端日志

后端日志输出在运行终端中，可搜索关键字：
- [DEBUG] Login
- [DEBUG] Starting electricity SSO flow

### 前端日志

浏览器/窗口 DevTools 控制台查看：
- [Cache] Cache HIT/MISS
- [Electricity] Token refresh failed

## 电费模块说明（简述）

- 电费查询依赖电费系统 SSO 与 Token。
- 后端实现位于：
  - src-tauri/src/http_client.rs
- 前端页面位于：
  - src/components/ElectricityView.vue
- 本地缓存：
  - 前端 localStorage（fetchWithCache）
  - 后端 SQLite 缓存（grades.db）

## 常见问题

### 1) 启动时报错缺少依赖

- 请确认已安装 Node.js 与 Rust。
- Windows 请确认已安装 C++ 构建工具。

### 2) Tauri 构建失败

- 清理后重试：
  - 删除 src-tauri/target
  - 重新执行 npm run tauri build

### 3) 电费查询失败

- 检查是否成功登录（日志是否仍停留在 authserver/login）。
- 重新登录或等待自动刷新（10分钟周期）。
- 如果无网或服务异常，将回退到本地缓存显示。

## 开发规范（建议）

- 前端请求通过 utils/api.js 中的缓存封装。
- Rust 侧新增 API 需在 src-tauri/src/lib.rs 中注册命令。
- 任何变更尽量保持接口结构与 Python 版一致。

## 快速定位文件

- 后端主逻辑：
  - src-tauri/src/http_client.rs
- 前端入口：
  - src/main.js
- 主界面路由控制：
  - src/App.vue
- 组件目录：
  - src/components/
