name: Release Build

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  CARGO_INCREMENTAL: 0

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Mini-HBUT ${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-android:
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Setup NDK
        run: |
          sdkmanager "ndk;27.0.11718014"
          echo "NDK_HOME=$ANDROID_SDK_ROOT/ndk/27.0.11718014" >> $GITHUB_ENV
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          # 鍙瀯寤?arm64 鏋舵瀯锛屽ぇ骞呭噺灏?APK 浣撶Н
          targets: aarch64-linux-android
      
      - name: Install dependencies
        run: npm ci
      
      - name: Initialize Android project
        run: npm run tauri android init
      
      - name: Copy Android icons
        run: |
          # 澶嶅埗鑷畾涔夊浘鏍囧埌 Android 椤圭洰
          ANDROID_RES="src-tauri/gen/android/app/src/main/res"
          ICONS_SRC="src-tauri/icons/android"
          
          # 澶嶅埗鍚勫垎杈ㄧ巼鍥炬爣
          for density in hdpi mdpi xhdpi xxhdpi xxxhdpi; do
            if [ -d "$ICONS_SRC/$density" ]; then
              mkdir -p "$ANDROID_RES/mipmap-$density"
              cp -f "$ICONS_SRC/$density"/*.png "$ANDROID_RES/mipmap-$density/" 2>/dev/null || true
            fi
            if [ -d "$ICONS_SRC/mipmap-$density" ]; then
              mkdir -p "$ANDROID_RES/mipmap-$density"
              cp -f "$ICONS_SRC/mipmap-$density"/*.png "$ANDROID_RES/mipmap-$density/" 2>/dev/null || true
            fi
          done
          
          echo "Android icons copied successfully"
          ls -la "$ANDROID_RES/mipmap-xxxhdpi/" || true
      
      # - name: Apply Android Native Changes (Service & Permissions)
      #   run: |
      #     ANDROID_MAIN="src-tauri/gen/android/app/src/main"
      #     SETUP_DIR="src-tauri/android-native-setup"
          
      #     # 1. Copy NotificationService.kt
      #     echo "Copying NotificationService.kt..."
      #     cp "$SETUP_DIR/NotificationService.kt" "$ANDROID_MAIN/java/com/hbut/mini/"
          
      #     # 2. Overwrite MainActivity.kt (using our valid version with service start logic)
      #     echo "Overwriting MainActivity.kt..."
      #     cp "$SETUP_DIR/MainActivity_changes.kt" "$ANDROID_MAIN/java/com/hbut/mini/MainActivity.kt"
          
      #     # 3. Patch AndroidManifest.xml
      #     MANIFEST="$ANDROID_MAIN/AndroidManifest.xml"
      #     echo "Patching AndroidManifest.xml..."
          
      #     # Insert Permissions (one by one to be safe)
      #     sed -i '/<application/i <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />' "$MANIFEST"
      #     sed -i '/<application/i <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />' "$MANIFEST"
      #     sed -i '/<application/i <uses-permission android:name="android.permission.WAKE_LOCK" />' "$MANIFEST"
      #     sed -i '/<application/i <uses-permission android:name="android.permission.REQUEST_IGNORE_BATTERY_OPTIMIZATIONS" />' "$MANIFEST"
          
      #     # Insert Service (inside <application>)
      #     sed -i '/<\/application>/i <service android:name=".NotificationService" />' "$MANIFEST"
          
      #     cat "$MANIFEST" | head -n 20
      
      # - name: Configure Android build for smaller APK
      #   run: |
      #     # 淇敼 build.gradle.kts 鍚敤浠ｇ爜鍘嬬缉
      #     BUILD_GRADLE="src-tauri/gen/android/app/build.gradle.kts"
      #     if [ -f "$BUILD_GRADLE" ]; then
      #       # 鍚敤 minify 鍜?shrinkResources
      #       sed -i 's/isMinifyEnabled = false/isMinifyEnabled = true/' "$BUILD_GRADLE"
      #       sed -i 's/isShrinkResources = false/isShrinkResources = true/' "$BUILD_GRADLE"
            
      #       # 闄愬埗鍙瀯寤?arm64-v8a 鏋舵瀯
      #       sed -i '/defaultConfig {/a\        ndk {\n            abiFilters += listOf("arm64-v8a")\n        }' "$BUILD_GRADLE"
      #     fi
          
      #     # 鍒涘缓 proguard 瑙勫垯鏂囦欢
      #     PROGUARD_FILE="src-tauri/gen/android/app/proguard-rules.pro"
      #     cat > "$PROGUARD_FILE" << 'EOF'
      #     # Tauri 淇濇寔瑙勫垯
      #     -keep class com.hbut.mini.** { *; }
      #     -keep class * extends android.webkit.WebView { *; }
      #     -keepclassmembers class * extends android.webkit.WebView {
      #         public *;
      #     }
      #     -dontwarn kotlin.**
      #     -dontwarn kotlinx.**
      #     EOF
      
      - name: Build Android APK (arm64 only)
        run: npm run tauri android build -- --target aarch64 --apk true
        env:
          NDK_HOME: ${{ env.NDK_HOME }}
      
      - name: Sign APK
        run: |
          # 鑾峰彇鐗堟湰鍙?          VERSION="${GITHUB_REF#refs/tags/v}"
          
          # 鎵惧埌鏈鍚嶇殑 APK
          UNSIGNED_APK=$(find src-tauri/gen/android/app/build/outputs/apk -name "*.apk" | head -1)
          echo "Found unsigned APK: $UNSIGNED_APK"
          
          # 浠?Secrets 瑙ｇ爜绛惧悕瀵嗛挜锛屽鏋滄病鏈夊垯鐢熸垚鏂扮殑
          if [ -n "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > release-key.jks
            echo "Using keystore from secrets"
          else
            # 浣跨敤鍥哄畾鍙傛暟鐢熸垚瀵嗛挜锛堢‘淇濇瘡娆＄敓鎴愮浉鍚岋級
            keytool -genkeypair -v \
              -keystore release-key.jks \
              -alias mini-hbut \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -storepass android \
              -keypass android \
              -dname "CN=Mini-HBUT, OU=HBUT, O=HBUT, L=Wuhan, ST=Hubei, C=CN"
            echo "Generated new keystore"
          fi
          
          # 瀵归綈 APK
          ${ANDROID_SDK_ROOT}/build-tools/35.0.0/zipalign -v -p 4 \
            "$UNSIGNED_APK" \
            app-aligned.apk
          
          # 绛惧悕 APK
          ${ANDROID_SDK_ROOT}/build-tools/35.0.0/apksigner sign \
            --ks release-key.jks \
            --ks-key-alias mini-hbut \
            --ks-pass pass:android \
            --key-pass pass:android \
            --out "Mini-HBUT-v${VERSION}-arm64.apk" \
            app-aligned.apk
          
          # 楠岃瘉绛惧悕
          ${ANDROID_SDK_ROOT}/build-tools/35.0.0/apksigner verify -v "Mini-HBUT-v${VERSION}-arm64.apk"
          
          # 鏄剧ず鏂囦欢淇℃伅
          ls -lh "Mini-HBUT-v${VERSION}-arm64.apk"
      
      - name: Upload signed APK
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: Mini-HBUT-*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-windows:
    needs: create-release
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build Windows App
        run: npm run tauri build
      
      - name: Upload Windows artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    needs: create-release
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build macOS App (Universal)
        run: npm run tauri build -- --target universal-apple-darwin
      
      - name: Upload macOS artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: src-tauri/target/universal-apple-darwin/release/bundle/dmg/*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-ios:
    needs: create-release
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Frontend Dependencies
        run: npm install

      - name: Install Tauri CLI
        run: npm install -g @tauri-apps/cli

      - name: Build Project
        run: |
          npm run tauri ios init
          npm run build
          export TMPDIR="$PWD/.tauri-tmp"
          mkdir -p "$TMPDIR"
          npm install ws --no-save
          cat > "$TMPDIR/tauri-cli-options-server.js" <<'NODE'
          const WebSocket = require('ws');

          const options = {
            dev: false,
            features: null,
            args: ['--lib'],
            noise_level: 'Polite',
            vars: {},
            config: [],
            target_device: null,
          };

          const port = parseInt(process.env.TAURI_CLI_OPTIONS_PORT || '0', 10);
          const server = new WebSocket.Server({ host: '127.0.0.1', port }, () => {
            const addr = server.address();
            const addrStr = `${addr.address}:${addr.port}`;
            console.log(`CLI options WS server ${addrStr}`);
          });

          server.on('connection', (ws) => {
            ws.on('message', (data) => {
              let msg;
              try { msg = JSON.parse(data.toString()); } catch { return; }
              if (msg && msg.method === 'options') {
                ws.send(JSON.stringify({ jsonrpc: '2.0', id: msg.id ?? 1, result: options }));
              }
            });
          });

          process.stdin.resume();
          NODE
          IDENTIFIER=$(node -p "require('./src-tauri/tauri.conf.json').identifier")
          PORT=$(python - <<'PY'
import socket
s = socket.socket()
s.bind(('127.0.0.1', 0))
print(s.getsockname()[1])
s.close()
PY
          )
          echo "127.0.0.1:$PORT" > "$TMPDIR/${IDENTIFIER}-server-addr"
          TAURI_CLI_OPTIONS_PORT=$PORT TMPDIR="$TMPDIR" NODE_PATH="$PWD/node_modules" node "$TMPDIR/tauri-cli-options-server.js" &
          OPTIONS_PID=$!
          for i in {1..40}; do
            if [ -f "${TMPDIR:-/tmp}/${IDENTIFIER}-server-addr" ]; then
              break
            fi
            sleep 0.5
          done
          if [ ! -f "${TMPDIR:-/tmp}/${IDENTIFIER}-server-addr" ]; then
            echo "Missing addr file: ${TMPDIR:-/tmp}/${IDENTIFIER}-server-addr"
            exit 1
          fi
          TMPDIR="$TMPDIR" xcodebuild \
            -workspace src-tauri/gen/apple/hbut-helper.xcodeproj/project.xcworkspace \
            -scheme hbut-helper_iOS \
            -configuration Release \
            -sdk iphoneos \
            -destination "generic/platform=iOS" \
            -derivedDataPath build-ios \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_IDENTITY="" \
            DEVELOPMENT_TEAM=""
          kill $OPTIONS_PID
      - name: Package IPA for SideStore
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          mkdir -p Payload
          APP_PATH=$(find build-ios/Build/Products/Release-iphoneos -type d -name "*.app" | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "No .app found under build-ios/Build/Products/Release-iphoneos"
            exit 1
          fi
          cp -R "$APP_PATH" Payload/
          IPA_NAME="Mini-HBUT_${VERSION}_iOS.ipa"
          zip -r "$IPA_NAME" Payload
          ls -lh "$IPA_NAME"

      - name: Upload iOS IPA
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: Mini-HBUT_${{ steps.version.outputs.VERSION }}_iOS.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libssl-dev \
            build-essential

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: npm ci

      - name: Build Linux App
        run: npm run tauri build

      - name: Upload Linux artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            src-tauri/target/release/bundle/appimage/*.AppImage
            src-tauri/target/release/bundle/deb/*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}














