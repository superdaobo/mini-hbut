name: Release Build

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  CARGO_INCREMENTAL: 0

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Mini-HBUT ${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-android:
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Setup NDK
        run: |
          sdkmanager "ndk;27.0.11718014"
          echo "NDK_HOME=$ANDROID_SDK_ROOT/ndk/27.0.11718014" >> $GITHUB_ENV
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          # 只构建 arm64 架构，大幅减少 APK 体积
          targets: aarch64-linux-android
      
      - name: Install dependencies
        run: npm ci
      
      - name: Initialize Android project
        run: npm run tauri android init
      
      - name: Copy Android icons
        run: |
          # 复制自定义图标到 Android 项目
          ANDROID_RES="src-tauri/gen/android/app/src/main/res"
          ICONS_SRC="src-tauri/icons/android"
          
          # 复制各分辨率图标
          for density in hdpi mdpi xhdpi xxhdpi xxxhdpi; do
            if [ -d "$ICONS_SRC/$density" ]; then
              mkdir -p "$ANDROID_RES/mipmap-$density"
              cp -f "$ICONS_SRC/$density"/*.png "$ANDROID_RES/mipmap-$density/" 2>/dev/null || true
            fi
            if [ -d "$ICONS_SRC/mipmap-$density" ]; then
              mkdir -p "$ANDROID_RES/mipmap-$density"
              cp -f "$ICONS_SRC/mipmap-$density"/*.png "$ANDROID_RES/mipmap-$density/" 2>/dev/null || true
            fi
          done
          
          echo "Android icons copied successfully"
          ls -la "$ANDROID_RES/mipmap-xxxhdpi/" || true
      
      # - name: Apply Android Native Changes (Service & Permissions)
      #   run: |
      #     ANDROID_MAIN="src-tauri/gen/android/app/src/main"
      #     SETUP_DIR="src-tauri/android-native-setup"
          
      #     # 1. Copy NotificationService.kt
      #     echo "Copying NotificationService.kt..."
      #     cp "$SETUP_DIR/NotificationService.kt" "$ANDROID_MAIN/java/com/hbut/mini/"
          
      #     # 2. Overwrite MainActivity.kt (using our valid version with service start logic)
      #     echo "Overwriting MainActivity.kt..."
      #     cp "$SETUP_DIR/MainActivity_changes.kt" "$ANDROID_MAIN/java/com/hbut/mini/MainActivity.kt"
          
      #     # 3. Patch AndroidManifest.xml
      #     MANIFEST="$ANDROID_MAIN/AndroidManifest.xml"
      #     echo "Patching AndroidManifest.xml..."
          
      #     # Insert Permissions (one by one to be safe)
      #     sed -i '/<application/i <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />' "$MANIFEST"
      #     sed -i '/<application/i <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />' "$MANIFEST"
      #     sed -i '/<application/i <uses-permission android:name="android.permission.WAKE_LOCK" />' "$MANIFEST"
      #     sed -i '/<application/i <uses-permission android:name="android.permission.REQUEST_IGNORE_BATTERY_OPTIMIZATIONS" />' "$MANIFEST"
          
      #     # Insert Service (inside <application>)
      #     sed -i '/<\/application>/i <service android:name=".NotificationService" />' "$MANIFEST"
          
      #     cat "$MANIFEST" | head -n 20
      
      # - name: Configure Android build for smaller APK
      #   run: |
      #     # 修改 build.gradle.kts 启用代码压缩
      #     BUILD_GRADLE="src-tauri/gen/android/app/build.gradle.kts"
      #     if [ -f "$BUILD_GRADLE" ]; then
      #       # 启用 minify 和 shrinkResources
      #       sed -i 's/isMinifyEnabled = false/isMinifyEnabled = true/' "$BUILD_GRADLE"
      #       sed -i 's/isShrinkResources = false/isShrinkResources = true/' "$BUILD_GRADLE"
            
      #       # 限制只构建 arm64-v8a 架构
      #       sed -i '/defaultConfig {/a\        ndk {\n            abiFilters += listOf("arm64-v8a")\n        }' "$BUILD_GRADLE"
      #     fi
          
      #     # 创建 proguard 规则文件
      #     PROGUARD_FILE="src-tauri/gen/android/app/proguard-rules.pro"
      #     cat > "$PROGUARD_FILE" << 'EOF'
      #     # Tauri 保持规则
      #     -keep class com.hbut.mini.** { *; }
      #     -keep class * extends android.webkit.WebView { *; }
      #     -keepclassmembers class * extends android.webkit.WebView {
      #         public *;
      #     }
      #     -dontwarn kotlin.**
      #     -dontwarn kotlinx.**
      #     EOF
      
      - name: Build Android APK (arm64 only)
        run: npm run tauri android build -- --target aarch64 --apk true
        env:
          NDK_HOME: ${{ env.NDK_HOME }}
      
      - name: Sign APK
        run: |
          # 获取版本号
          VERSION="${GITHUB_REF#refs/tags/v}"
          
          # 找到未签名的 APK
          UNSIGNED_APK=$(find src-tauri/gen/android/app/build/outputs/apk -name "*.apk" | head -1)
          echo "Found unsigned APK: $UNSIGNED_APK"
          
          # 从 Secrets 解码签名密钥，如果没有则生成新的
          if [ -n "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > release-key.jks
            echo "Using keystore from secrets"
          else
            # 使用固定参数生成密钥（确保每次生成相同）
            keytool -genkeypair -v \
              -keystore release-key.jks \
              -alias mini-hbut \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -storepass android \
              -keypass android \
              -dname "CN=Mini-HBUT, OU=HBUT, O=HBUT, L=Wuhan, ST=Hubei, C=CN"
            echo "Generated new keystore"
          fi
          
          # 对齐 APK
          ${ANDROID_SDK_ROOT}/build-tools/35.0.0/zipalign -v -p 4 \
            "$UNSIGNED_APK" \
            app-aligned.apk
          
          # 签名 APK
          ${ANDROID_SDK_ROOT}/build-tools/35.0.0/apksigner sign \
            --ks release-key.jks \
            --ks-key-alias mini-hbut \
            --ks-pass pass:android \
            --key-pass pass:android \
            --out "Mini-HBUT-v${VERSION}-arm64.apk" \
            app-aligned.apk
          
          # 验证签名
          ${ANDROID_SDK_ROOT}/build-tools/35.0.0/apksigner verify -v "Mini-HBUT-v${VERSION}-arm64.apk"
          
          # 显示文件信息
          ls -lh "Mini-HBUT-v${VERSION}-arm64.apk"
      
      - name: Upload signed APK
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: Mini-HBUT-*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-windows:
    needs: create-release
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build Windows App
        run: npm run tauri build
      
      - name: Upload Windows artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    needs: create-release
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build macOS App (Universal)
        run: npm run tauri build -- --target universal-apple-darwin
      
      - name: Upload macOS artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: src-tauri/target/universal-apple-darwin/release/bundle/dmg/*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-ios:
    needs: create-release
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Frontend Dependencies
        run: npm install

      - name: Install Tauri CLI
        run: npm install -g @tauri-apps/cli

      - name: Build Project
        run: |
          npm run tauri ios init
          npm run tauri ios build -- --target aarch64 --export-method debugging

      - name: Package IPA for SideStore
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          mkdir -p Payload
          APP_PATH=$(find src-tauri/gen/apple -type d -name "*.app" | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "No .app found under src-tauri/gen/apple"
            exit 1
          fi
          cp -R "$APP_PATH" Payload/
          IPA_NAME="Mini-HBUT_${VERSION}_iOS.ipa"
          zip -r "$IPA_NAME" Payload
          ls -lh "$IPA_NAME"

      - name: Upload iOS IPA
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: Mini-HBUT_${{ steps.version.outputs.VERSION }}_iOS.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libssl-dev \
            build-essential

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: npm ci

      - name: Build Linux App
        run: npm run tauri build

      - name: Upload Linux artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            src-tauri/target/release/bundle/appimage/*.AppImage
            src-tauri/target/release/bundle/deb/*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
