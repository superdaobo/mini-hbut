name: Release Build

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  CARGO_INCREMENTAL: 0

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Mini-HBUT ${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-android:
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Setup NDK
        run: |
          sdkmanager "ndk;27.0.11718014"
          echo "NDK_HOME=$ANDROID_SDK_ROOT/ndk/27.0.11718014" >> $GITHUB_ENV
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          # 只构建 arm64 架构，大幅减少 APK 体积
          targets: aarch64-linux-android
      
      - name: Install dependencies
        run: npm ci
      
      - name: Initialize Android project
        run: npm run tauri android init
      
      - name: Configure Android build for smaller APK
        run: |
          # 修改 build.gradle.kts 启用代码压缩
          BUILD_GRADLE="src-tauri/gen/android/app/build.gradle.kts"
          if [ -f "$BUILD_GRADLE" ]; then
            # 启用 minify 和 shrinkResources
            sed -i 's/isMinifyEnabled = false/isMinifyEnabled = true/' "$BUILD_GRADLE"
            sed -i 's/isShrinkResources = false/isShrinkResources = true/' "$BUILD_GRADLE"
            
            # 限制只构建 arm64-v8a 架构
            sed -i '/defaultConfig {/a\        ndk {\n            abiFilters += listOf("arm64-v8a")\n        }' "$BUILD_GRADLE"
          fi
          
          # 创建 proguard 规则文件
          PROGUARD_FILE="src-tauri/gen/android/app/proguard-rules.pro"
          cat > "$PROGUARD_FILE" << 'EOF'
          # Tauri 保持规则
          -keep class com.hbut.mini.** { *; }
          -keep class * extends android.webkit.WebView { *; }
          -keepclassmembers class * extends android.webkit.WebView {
              public *;
          }
          -dontwarn kotlin.**
          -dontwarn kotlinx.**
          EOF
      
      - name: Build Android APK (arm64 only)
        run: npm run tauri android build -- --target aarch64 --apk true
        env:
          NDK_HOME: ${{ env.NDK_HOME }}
      
      - name: Find and upload APK
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: src-tauri/gen/android/app/build/outputs/apk/**/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-windows:
    needs: create-release
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build Windows App
        run: npm run tauri build
      
      - name: Upload Windows artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    needs: create-release
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build macOS App (Universal)
        run: npm run tauri build -- --target universal-apple-darwin
      
      - name: Upload macOS artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: src-tauri/target/universal-apple-darwin/release/bundle/dmg/*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
