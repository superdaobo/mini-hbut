name: Dev Build

on:
  push:
    branches:
      - dev
  workflow_dispatch:

permissions:
  contents: read

env:
  CARGO_INCREMENTAL: 0

concurrency:
  group: dev-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  meta:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      beta_version: ${{ steps.version.outputs.beta_version }}
    steps:
      - uses: actions/checkout@v4

      - name: Resolve build version
        id: version
        run: |
          VERSION="$(python - <<'PY'
          import json
          with open('package.json', 'r', encoding='utf-8') as f:
              print(json.load(f).get('version', '0.0.0'))
          PY
          )"
          BETA_VERSION="${VERSION}-beta.${GITHUB_RUN_ID}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "beta_version=$BETA_VERSION" >> "$GITHUB_OUTPUT"
          echo "VERSION=$VERSION"
          echo "BETA_VERSION=$BETA_VERSION"

  build-android:
    needs: meta
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup NDK
        run: |
          sdkmanager "ndk;27.0.11718014"
          echo "NDK_HOME=$ANDROID_SDK_ROOT/ndk/27.0.11718014" >> "$GITHUB_ENV"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android

      - name: Install dependencies
        run: npm ci

      - name: Initialize Android project
        run: npm run tauri android init

      - name: Build Android APK (arm64)
        run: npm run tauri android build -- --target aarch64 --apk true
        env:
          NDK_HOME: ${{ env.NDK_HOME }}

      - name: Sign and rename APK
        env:
          BETA_VERSION: ${{ needs.meta.outputs.beta_version }}
        run: |
          set -euo pipefail
          UNSIGNED_APK="$(find src-tauri/gen/android/app/build/outputs/apk -name '*.apk' | head -n 1)"
          if [ -z "$UNSIGNED_APK" ]; then
            echo "No unsigned APK found."
            find src-tauri/gen/android/app/build/outputs -maxdepth 6 -type f -print || true
            exit 1
          fi

          if [ -n "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > release-key.jks
          else
            keytool -genkeypair -v \
              -keystore release-key.jks \
              -alias mini-hbut \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -storepass android \
              -keypass android \
              -dname "CN=Mini-HBUT, OU=HBUT, O=HBUT, L=Wuhan, ST=Hubei, C=CN"
          fi

          "${ANDROID_SDK_ROOT}/build-tools/35.0.0/zipalign" -v -p 4 "$UNSIGNED_APK" app-aligned.apk
          OUT_APK="Mini-HBUT_${BETA_VERSION}_arm64.apk"
          "${ANDROID_SDK_ROOT}/build-tools/35.0.0/apksigner" sign \
            --ks release-key.jks \
            --ks-key-alias mini-hbut \
            --ks-pass pass:android \
            --key-pass pass:android \
            --out "$OUT_APK" \
            app-aligned.apk
          "${ANDROID_SDK_ROOT}/build-tools/35.0.0/apksigner" verify -v "$OUT_APK"
          ls -lh "$OUT_APK"

      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-${{ needs.meta.outputs.beta_version }}
          path: Mini-HBUT_${{ needs.meta.outputs.beta_version }}_arm64.apk
          if-no-files-found: error
          retention-days: 14

  build-windows:
    needs: meta
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: npm ci

      - name: Build Windows app
        run: npm run tauri build

      - name: Rename Windows bundles
        shell: powershell
        env:
          BETA_VERSION: ${{ needs.meta.outputs.beta_version }}
        run: |
          New-Item -ItemType Directory -Force -Path dist-dev | Out-Null
          $exe = Get-ChildItem "src-tauri/target/release/bundle/nsis/*.exe" | Select-Object -First 1
          if (-not $exe) { throw "NSIS EXE not found" }
          Copy-Item $exe.FullName "dist-dev/Mini-HBUT_$env:BETA_VERSION`_x64-setup.exe" -Force

          $msi = Get-ChildItem "src-tauri/target/release/bundle/msi/*.msi" | Select-Object -First 1
          if ($msi) {
            $msiName = "Mini-HBUT_$env:BETA_VERSION`_x64.msi"
            if ($msi.Name -match "en-US") {
              $msiName = "Mini-HBUT_$env:BETA_VERSION`_x64_en-US.msi"
            }
            Copy-Item $msi.FullName ("dist-dev/" + $msiName) -Force
          }
          Get-ChildItem dist-dev

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ needs.meta.outputs.beta_version }}
          path: dist-dev/*
          if-no-files-found: error
          retention-days: 14

  build-macos:
    needs: meta
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: Install dependencies
        run: npm ci

      - name: Build macOS app (universal)
        run: npm run tauri build -- --target universal-apple-darwin

      - name: Rename macOS bundle
        env:
          BETA_VERSION: ${{ needs.meta.outputs.beta_version }}
        run: |
          set -euo pipefail
          mkdir -p dist-dev
          DMG="$(find src-tauri/target/universal-apple-darwin/release/bundle/dmg -name '*.dmg' | head -n 1)"
          if [ -z "$DMG" ]; then
            echo "DMG not found"
            exit 1
          fi
          cp "$DMG" "dist-dev/Mini-HBUT_${BETA_VERSION}_universal.dmg"
          ls -lh dist-dev

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ needs.meta.outputs.beta_version }}
          path: dist-dev/Mini-HBUT_${{ needs.meta.outputs.beta_version }}_universal.dmg
          if-no-files-found: error
          retention-days: 14

  build-ios:
    needs: meta
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Tauri CLI
        run: npm install -g @tauri-apps/cli

      - name: Build iOS app bundle
        run: |
          set -euo pipefail
          node --input-type=module - <<'NODE'
          import fs from 'node:fs';
          const p = 'src-tauri/tauri.conf.json';
          const conf = JSON.parse(fs.readFileSync(p, 'utf8'));
          conf.build = conf.build || {};
          delete conf.build.devUrl;
          delete conf.build.beforeDevCommand;
          conf.build.beforeBuildCommand = 'npm run build';
          conf.build.frontendDist = conf.build.frontendDist || '../dist';
          fs.writeFileSync(p, JSON.stringify(conf, null, 2) + '\n');
          console.log('Patched tauri.conf.json for iOS CI.');
          NODE

          npm run tauri ios init
          npm run build

          export TMPDIR="$PWD/.tauri-tmp"
          export NPM_CONFIG_AUDIT=false
          export NPM_CONFIG_FUND=false
          mkdir -p "$TMPDIR"

          npm install ws --no-save --no-audit --no-fund
          node -e "require('ws'); console.log('ws ok')"

          cp tools/ci/tauri-cli-options-server.cjs "$TMPDIR/tauri-cli-options-server.cjs"

          IDENTIFIER="$(node -p "require('./src-tauri/tauri.conf.json').identifier")"
          PORT="$(python -c "import socket; s=socket.socket(); s.bind(('127.0.0.1', 0)); print(s.getsockname()[1]); s.close()")"
          export PORT
          echo "127.0.0.1:$PORT" > "$TMPDIR/${IDENTIFIER}-server-addr"

          LOG="$TMPDIR/tauri-cli-options-server.log"
          TAURI_CLI_OPTIONS_PORT="$PORT" TMPDIR="$TMPDIR" NODE_PATH="$PWD/node_modules" node "$TMPDIR/tauri-cli-options-server.cjs" >"$LOG" 2>&1 &
          OPTIONS_PID=$!
          cleanup() {
            if [ -n "${OPTIONS_PID:-}" ] && kill -0 "$OPTIONS_PID" 2>/dev/null; then
              kill "$OPTIONS_PID"
            fi
          }
          trap cleanup EXIT

          sleep 1
          if ! kill -0 "$OPTIONS_PID" 2>/dev/null; then
            echo "WS server process exited early"
            cat "$LOG"
            exit 1
          fi

          python - <<'PY'
          import os
          import socket
          import sys
          import time

          port = int(os.environ["PORT"])
          for _ in range(60):
              sock = socket.socket()
              sock.settimeout(0.2)
              try:
                  sock.connect(("127.0.0.1", port))
                  sock.close()
                  sys.exit(0)
              except Exception:
                  sock.close()
                  time.sleep(0.2)
          sys.exit(1)
          PY

          mkdir -p src-tauri/target/aarch64-apple-ios/debug
          ln -sf ../release/libhbut_helper_lib.a src-tauri/target/aarch64-apple-ios/debug/libhbut_helper_lib.a

          TMPDIR="$TMPDIR" xcodebuild \
            -workspace src-tauri/gen/apple/hbut-helper.xcodeproj/project.xcworkspace \
            -scheme hbut-helper_iOS \
            -configuration Release \
            -sdk iphoneos \
            -destination "generic/platform=iOS" \
            -derivedDataPath build-ios \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_IDENTITY="" \
            DEVELOPMENT_TEAM=""

      - name: Package IPA
        env:
          BETA_VERSION: ${{ needs.meta.outputs.beta_version }}
        run: |
          set -euo pipefail
          mkdir -p Payload

          APP_PATH=""
          for PATTERN in "*/Release-iphoneos/*.app" "*/release-iphoneos/*.app" "*/Debug-iphoneos/*.app" "*/debug-iphoneos/*.app"; do
            APP_PATH="$(find build-ios/Build/Products -path "$PATTERN" -type d | head -n 1 || true)"
            if [ -n "$APP_PATH" ]; then
              break
            fi
          done
          if [ -z "$APP_PATH" ]; then
            APP_PATH="$(find build-ios/Build/Products -path "*/iphoneos/*.app" -type d | head -n 1 || true)"
          fi
          if [ -z "$APP_PATH" ]; then
            echo "No iPhoneOS .app found under build-ios/Build/Products"
            find build-ios/Build/Products -maxdepth 6 -type d -print || true
            exit 1
          fi

          cp -R "$APP_PATH" Payload/
          IPA_NAME="Mini-HBUT_${BETA_VERSION}_iOS.ipa"
          zip -r "$IPA_NAME" Payload
          ls -lh "$IPA_NAME"

      - name: Upload iOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-${{ needs.meta.outputs.beta_version }}
          path: Mini-HBUT_${{ needs.meta.outputs.beta_version }}_iOS.ipa
          if-no-files-found: error
          retention-days: 14

  build-linux:
    needs: meta
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libssl-dev \
            build-essential

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: npm ci

      - name: Build Linux app
        run: npm run tauri build

      - name: Rename Linux bundles
        env:
          BETA_VERSION: ${{ needs.meta.outputs.beta_version }}
        run: |
          set -euo pipefail
          mkdir -p dist-dev
          APPIMAGE="$(find src-tauri/target/release/bundle/appimage -name '*.AppImage' | head -n 1 || true)"
          DEB="$(find src-tauri/target/release/bundle/deb -name '*.deb' | head -n 1 || true)"

          if [ -z "$APPIMAGE" ] && [ -z "$DEB" ]; then
            echo "No Linux bundle found"
            exit 1
          fi

          if [ -n "$APPIMAGE" ]; then
            cp "$APPIMAGE" "dist-dev/Mini-HBUT_${BETA_VERSION}_amd64.AppImage"
          fi
          if [ -n "$DEB" ]; then
            cp "$DEB" "dist-dev/Mini-HBUT_${BETA_VERSION}_amd64.deb"
          fi
          ls -lh dist-dev

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ needs.meta.outputs.beta_version }}
          path: dist-dev/*
          if-no-files-found: error
          retention-days: 14
